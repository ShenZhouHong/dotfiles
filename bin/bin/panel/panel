#! /bin/bash

if [ "$(pgrep -cx panel)" -gt 1 ] ; then
    echo "The panel is already running." 
    exit 1
fi

# trap 'trap - TERM; kill 0' INT TERM QUIT EXIT


init() {
    source api_keys.sh
    source modules.sh
    source settings.sh
    . panel_colors light
    mkfifo "$PANEL_FIFO_2" "$CLOCK_FIFO" "$PANEL_FIFO"
    bspc subscribe > "$PANEL_FIFO" &
}

shutdown() {
    # Get our process group id
    PGID=$(ps -o pgid=$$ | head -n 1)
    echo "PGID: $PGID"
    # Kill it in a new new process group
    setsid kill -- "-$PGID"
}

trap shutdown EXIT SIGTERM SIGUSR1

loop() {
    i=0
    while true; do
        keyboard &
        battery &
        music &
        wifi & 
        wallpaper &
        alsa_volume &
        if (( i % 60 == 0 )); then 
            clock & 
            calendar &
        fi
        if (( i % 400 == 0 )); then
            mail &
            pollution & 
            weather &
        fi
        i=$((i+1))
        # Just in case $i gets enormously large and causes problems. 
        # The value in brackets should be a multiple of the other cycles' values
        (( i >= 1600 )) && i=0 
        sleep 1
    done > "$PANEL_FIFO" 2>/dev/null &
}

main() {
    init
    loop
    PANEL_WM_NAME="bar_wmname"
    panel_bar 1 < "$PANEL_FIFO" | lemonbar -d -n "$PANEL_WM_NAME" -a 20 -o -4 -g $PANEL_WIDTH\x$PANEL_HEIGHT+$PANEL_GAP+$PANEL_GAP -f "$PANEL_FONT_FAMILY" -f "$POWERLINE_FONT" -f "$ICON_FONT" -f "$ICON_FONT_2" -F "$COLOR_FOREGROUND" -B "$COLOR_BACKGROUND" -u 2|  zsh &

    # cat "$PANEL_FIFO_2" | panel_bar 2 | lemonbar -g 1910x$PANEL_HEIGHT+1365+5 -f "$PANEL_FONT_FAMILY" -f "$POWERLINE_FONT" -f "$ICON_FONT" -f "$ICON_FONT_2" -F "$COLOR_FOREGROUND" -B "$COLOR_BACKGROUND" -u 2 |  zsh &


    tries_left=20
    while [ -z "$wid" ] && [ "$tries_left" -gt 0 ] ; do
            sleep 0.05
            wid=$(xdo id -a "$PANEL_WM_NAME")
            tries_left=$((tries_left - 1))
    done

    [ -n "$wid" ] && xdo above -t "$(xdo id -N Bspwm -n root | sort | head -n 1)" "$wid"

    wait
}

main
